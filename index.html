<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Route Appointments</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);min-height:100vh;color:#fff;overflow-y:auto}
        .container{width:100vw;height:100vh;display:flex;flex-direction:column}
        
        .data-config{background:rgba(30,60,114,0.95);border-radius:8px;padding:10px;margin:5px;display:none;position:fixed;top:60px;right:10px;z-index:100;width:350px;max-height:calc(100vh - 80px);overflow-y:auto;box-shadow:0 5px 20px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1)}
        .config-input-group{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
        .config-input{flex:1;min-width:200px;padding:8px;border:1px solid rgba(255,255,255,0.2);border-radius:6px;background:rgba(255,255,255,0.1);color:#fff;font-size:0.9em}
        .config-input::placeholder{color:rgba(255,255,255,0.6)}
        .config-input:focus{outline:none;border-color:#4a90e2;background:rgba(255,255,255,0.15)}
        .config-buttons{display:flex;gap:10px;flex-wrap:wrap}
        .config-btn{padding:8px 20px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:all 0.3s ease;text-decoration:none;display:inline-flex;align-items:center;gap:8px;font-size:0.9em}
        .load-btn{background:linear-gradient(135deg,#4caf50 0%,#45a049 100%);color:white}
        .clear-btn{background:linear-gradient(135deg,#f44336 0%,#d32f2f 100%);color:white}
        .export-btn{background:linear-gradient(135deg,#2196f3 0%,#1976d2 100%);color:white}
        .upload-btn{background:linear-gradient(135deg,#9c27b0 0%,#7b1fa2 100%);color:white}
        .save-btn{background:linear-gradient(135deg,#ff9800 0%,#f57c00 100%);color:white}
        .connection-status{margin-top:8px;padding:8px;border-radius:8px;font-weight:500;display:flex;align-items:center;gap:8px}
        .status-connected{background:rgba(76,175,80,0.2);color:#4caf50}
        .status-disconnected{background:rgba(244,67,54,0.2);color:#f44336}
        
        .file-upload-section{margin-bottom:15px;padding:10px;border:1px dashed rgba(255,255,255,0.3);border-radius:6px;background:rgba(255,255,255,0.05)}
        .file-input{margin-bottom:10px}
        .file-input input[type="file"]{padding:8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;width:100%}
        .password-section{display:none;margin-top:10px}
        .password-input{width:100%;padding:8px;border:1px solid rgba(255,255,255,0.2);border-radius:6px;background:rgba(255,255,255,0.1);color:#fff}
        
        .data-export-section{margin-bottom:15px;padding:10px;border:1px solid rgba(255,255,255,0.3);border-radius:6px;background:rgba(255,255,255,0.05)}
        .export-info{font-size:0.9em;color:#b8d4f0;margin-bottom:10px}
        
        .tab-navigation{display:flex;background:rgba(255,255,255,0.05);padding:8px;gap:8px;align-items:center}
        .tab-btn{flex:1;padding:12px 20px;background:rgba(255,255,255,0.1);border:none;border-radius:6px;color:#b8d4f0;font-weight:500;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;gap:8px;font-size:1em}
        .tab-btn.active{background:linear-gradient(135deg,#4a90e2 0%,#2a5298 100%);color:#fff;font-weight:600}
        .tab-btn:hover:not(.active){background:rgba(255,255,255,0.15);color:#fff}
        
        .tech-id-container{display:flex;align-items:center;gap:10px;padding:0 8px}
        .tech-id-input{padding:12px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:1em;min-width:120px}
        .tech-id-input::placeholder{color:rgba(255,255,255,0.6)}
        .tech-id-input:focus{outline:none;border-color:#4a90e2;background:rgba(255,255,255,0.15)}
        .tech-id-label{color:#b8d4f0;font-weight:500;white-space:nowrap;font-size:0.9em}
        
        .data-toggle-btn{padding:12px;background:rgba(255,255,255,0.1);border:none;border-radius:6px;color:#b8d4f0;cursor:pointer;transition:all 0.3s ease;font-size:1.2em}
        .data-toggle-btn:hover{background:rgba(255,255,255,0.2);color:#fff}
        
        .calendar-view{display:none;background:rgba(255,255,255,0.05);margin:5px;border-radius:8px;padding:10px;overflow-y:auto}
        .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding:0 5px}
        .calendar-nav-btn{background:linear-gradient(135deg,#4a90e2 0%,#2a5298 100%);border:none;color:white;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600}
        .calendar-title{font-size:1.3em;font-weight:bold;color:#fff}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;height:calc(100% - 60px)}
        
        .calendar-day{background:rgba(255,255,255,0.08);border-radius:6px;padding:8px;display:flex;flex-direction:column}
        .calendar-day.today{background:linear-gradient(135deg,#ff9800 0%,#f57c00 100%);color:white}
        .day-header{font-weight:bold;margin-bottom:10px;font-size:0.9em;text-align:center;padding:4px;line-height:1.2}
        
        .service-card{background:linear-gradient(135deg,#ff9800 0%,#f57c00 100%);color:white;font-size:0.75em;padding:8px;border-radius:6px;margin-bottom:4px;cursor:pointer;transition:all 0.2s ease;box-shadow:0 2px 4px rgba(0,0,0,0.2);line-height:1.4}
        .service-card.afternoon{background:linear-gradient(135deg,#2196f3 0%,#1976d2 100%)}
        .service-card:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.3)}
        .service-card-name{font-weight:600;margin-bottom:3px;display:flex;justify-content:space-between;align-items:center;font-size:1.05em}
        .service-card-location{font-size:0.95em;opacity:0.9;margin-bottom:3px}
        .service-card-notes{font-size:0.85em;opacity:0.8;font-style:italic}
        
        .appointment-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;z-index:1000}
        .appointment-modal.show{display:flex}
        .modal-content{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);border-radius:12px;padding:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 10px 30px rgba(0,0,0,0.5);position:relative}
        .modal-close{position:absolute;top:10px;right:15px;background:none;border:none;color:#fff;font-size:1.5em;cursor:pointer;opacity:0.7}
        .modal-close:hover{opacity:1}
        .modal-header{color:#fff;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.2);position:relative}
        .modal-customer{font-size:1.3em;font-weight:bold;margin-bottom:5px}
        .modal-service{font-size:1.1em;color:#4fc3f7;font-weight:500}
        .modal-body{color:#fff}
        .modal-field{margin-bottom:12px}
        .modal-field-right{position:absolute;top:0;right:0;margin:0;text-align:right}
        .modal-row{display:flex;gap:20px;margin-bottom:12px}
        .modal-row .modal-field{flex:1;margin-bottom:0}
        .modal-label{font-weight:600;color:#b8d4f0;font-size:0.9em;margin-bottom:3px;display:block}
        .modal-value{font-size:1em;line-height:1.4;word-wrap:break-word}
        
        .map-view{display:grid;grid-template-columns:1fr 450px;gap:10px;height:calc(100vh - 60px);padding:5px}
        .appointments-section{background:rgba(255,255,255,0.05);border-radius:8px;padding:10px;overflow-y:auto;max-height:100%;height:100%;display:flex;flex-direction:column}
        .map-section{background:rgba(255,255,255,0.05);border-radius:8px;padding:10px;display:flex;flex-direction:column;height:100%}
        
        .appointment-card{border-radius:8px;padding:8px;margin-bottom:6px;transition:all 0.3s ease;position:relative;cursor:pointer;border-left:4px solid #4a90e2}
        .appointment-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
        .appointment-card.highlight{
            box-shadow: 0 0 15px 5px #ffeb3b, 0 0 5px 2px #ffc107;
            border-color: #ffc107;
            transform: scale(1.02);
        }
        .appointment-card.completed{
            background:rgba(100,100,100,0.3);
            opacity:0.6;
            border-left-color:#666;
        }
        .appointment-card.completed .customer-name,
        .appointment-card.completed .address-link,
        .appointment-card.completed .phone-number,
        .appointment-card.completed .order-info{
            color:#aaa !important;
        }
        
        .reorder-up{position:absolute;left:8px;top:8px}
        .reorder-down{position:absolute;left:8px;bottom:8px}
        .reorder-btn{background:rgba(255,255,255,0.15);border:none;color:#4fc3f7;padding:4px 6px;border-radius:4px;cursor:pointer;font-size:0.8em;transition:all 0.2s ease;opacity:0.7}
        .reorder-btn:hover{background:rgba(255,255,255,0.25);opacity:1}
        .reorder-btn:disabled{opacity:0.3;cursor:not-allowed}
        
        .card-content{margin-left:40px}
        
        .appointment-top-row{display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:8px}
        .time-slot-btn{background:linear-gradient(135deg,#ff6b35 0%,#f7931e 100%);color:white;border:none;padding:6px 12px;border-radius:15px;font-size:0.8em;font-weight:600;cursor:pointer}
        .time-slot-btn.afternoon{background:linear-gradient(135deg,#2196f3 0%,#1976d2 100%)}
        .complete-btn{background:linear-gradient(135deg,#4caf50 0%,#45a049 100%);color:white;border:none;padding:6px 12px;border-radius:15px;font-size:0.8em;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px}
        
        .customer-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .customer-name{font-size:1.2em;font-weight:bold;color:#fff}
        .rnn-number{font-size:0.85em;color:#b8d4f0;font-weight:500}
        .address-link,.order-info{text-align:left}
        .address-link{color:#4fc3f7;text-decoration:none;font-weight:500;display:block;margin-bottom:8px;font-size:1em}
        .phone-container{display:flex;align-items:center;justify-content:space-between;margin:8px 0;flex-wrap:wrap}
        .phone-number{color:#fff;font-size:1em}
        .phone-buttons{display:flex;gap:8px}
        .phone-btn{padding:6px 12px;border:none;border-radius:20px;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:all 0.3s ease;font-size:0.8em}
        .call-btn{background:linear-gradient(135deg,#2ecc71 0%,#27ae60 100%);color:white}
        .text-btn{background:linear-gradient(135deg,#3498db 0%,#2980b9 100%);color:white}
        .order-info{margin-top:6px;padding:8px;border-radius:6px;font-size:1em;color:#fff;line-height:1.4}
        
        #map{width:100%;flex:1;border-radius:8px;min-height:200px}
        .last-updated{text-align:center;margin:5px;color:#b8d4f0;font-size:0.9em}
        .error{background:rgba(231,76,60,0.2);color:#ff6b6b;padding:8px;border-radius:6px;margin:5px;text-align:center}
        .no-data-message{text-align:center;padding:20px;color:#b8d4f0;font-size:1.1em;border-radius:8px}
        
        @media(max-width:470px){
            body.map-view-active .map-view{display:block !important;height:auto;padding:5px}
            body.map-view-active .appointments-section{max-height:55vh;margin-bottom:1px;padding-right:20px;margin-top:30px}
            body.map-view-active .map-section{position:static;height:25vh}
            body.map-view-active #map{height:100%;flex:none}
            
            .calendar-grid{height:auto;min-height:200px}
            .calendar-day{min-height:200px}
            .service-card{font-size:0.7em}
            .modal-content{max-width:95%}
            
            .tech-id-container{padding:4px;gap:5px}
            .tech-id-input{min-width:20px;padding:8px;font-size:0.9em}
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCtbuOit9J3vW1PJ0F3uYxy-QlCY3jE2UM&callback=initMap" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
    <div class="data-config">
        <div class="file-upload-section">
            <div class="file-input">
                <label style="display:block;margin-bottom:5px;color:#b8d4f0;font-weight:500;">Upload Excel File (ExportExcel_Service List Info_*):</label>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
            </div>
            <div class="password-section" id="passwordSection">
                <label style="display:block;margin-bottom:5px;color:#b8d4f0;font-weight:500;">Excel Password:</label>
                <input type="password" id="excelPassword" class="password-input" placeholder="Enter Excel password">
                <button class="config-btn upload-btn" onclick="processExcelFile()" style="margin-top:10px;">Process Excel File</button>
            </div>
        </div>
        
        <div class="data-export-section">
            <div class="export-info">Save/Load appointment data locally:</div>
            <div class="config-buttons">
                <button class="config-btn save-btn" onclick="saveDataLocally()">Save Data</button>
                <button class="config-btn load-btn" onclick="loadDataLocally()">Load Data</button>
                <button class="config-btn export-btn" onclick="exportToExcel()">Export to Excel</button>
                <button class="config-btn clear-btn" onclick="clearAllData()">Clear All</button>
            </div>
        </div>
        
        <div id="connectionStatus" class="connection-status status-disconnected">Local data storage active</div>
        <div id="errorContainer"></div>
    </div>

    <div class="tab-navigation">
        <button class="tab-btn active" onclick="switchTab('map')">Map</button>
        <button class="tab-btn" onclick="switchTab('calendar')">Calendar</button>
        <button class="tab-btn" onclick="openGoogleMapsRoute()">Directions</button>
        <div class="tech-id-container">
            <label class="tech-id-label">Tech ID:</label>
            <input type="text" id="techIdInput" class="tech-id-input" placeholder="Enter Tech ID" onchange="onTechIdChange()">
        </div>
        <button class="data-toggle-btn" onclick="toggleDataConfig()">⚙️</button>
    </div>

    <div id="mapView" class="map-view">
        <div class="map-section">
            <div id="map"></div>
        </div>
        <div id="appointmentsListContainer" class="appointments-section">
            <div id="appointmentsList" class="no-data-message">
                <strong>Upload Excel File</strong><br>
                Click the ⚙️ icon above, upload an Excel file, then enter a Tech ID to load appointments.
            </div>
        </div>
    </div>
  
    <div id="calendarView" class="calendar-view">
        <div class="calendar-header">
            <button class="calendar-nav-btn" onclick="navigateWeek(-1)">← Previous Week</button>
            <div class="calendar-title" id="calendarTitle">Week of September 2025</div>
            <button class="calendar-nav-btn" onclick="navigateWeek(1)">Next Week →</button>
        </div>
        <div class="calendar-grid" id="calendarGrid">
            <div style="text-align:center;padding:20px;color:#b8d4f0;">Loading calendar...</div>
        </div>
    </div>
        
<div id="appointmentModal" class="appointment-modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeAppointmentModal()">×</button>
        <div class="modal-header">
            <div class="modal-customer" id="modalCustomer">Customer Name</div>
            <div class="modal-service" id="modalService">Service Type</div>
            <div class="modal-field modal-field-right">
                <span class="modal-label">Time Slot:</span>
                <div class="modal-value" id="modalTimeSlot">-</div>
            </div>
        </div>
        <div class="modal-body">
            <div class="modal-row">
                <div class="modal-field">
                    <span class="modal-label">Order ID:</span>
                    <div class="modal-value" id="modalOrderId">-</div>
                </div>
                <div class="modal-field">
                    <span class="modal-label">Location:</span>
                    <div class="modal-value" id="modalLocation">-</div>
                </div>
            </div>

            <div class="modal-row">
                <div class="modal-field">
                    <span class="modal-label">Serial:</span>
                    <div class="modal-value" id="modalSerial">-</div>
                </div>
                <div class="modal-field">
                    <span class="modal-label">Model:</span>
                    <div class="modal-value" id="modalModel">-</div>
                </div>
            </div>

            <div class="modal-field">
                <span class="modal-label">Notes:</span>
                <div class="modal-value" id="modalNotes">-</div>
            </div>
            <div class="modal-field">
                <span class="modal-label">LG Remarks:</span>
                <div class="modal-value" id="modalLgRemarks">-</div>
            </div>
            <div class="modal-field">
                <span class="modal-label">Symptom 1:</span>
                <div class="modal-value" id="modalSymptom1">-</div>
            </div>
            <div class="modal-field">
                <span class="modal-label">Symptom 2:</span>
                <div class="modal-value" id="modalSymptom2">-</div>
            </div>
            <div class="modal-field">
                <span class="modal-label">CiC Remark:</span>
                <div class="modal-value" id="modalCicRemark">-</div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let appointments = [], serviceOrders = [], currentWeekStart = new Date();
let map, markers = [], infoWindows = [];
let geocoder;
let currentTechId = '';
let directionsService, directionsRenderer;
let uploadedExcelFile = null;
let allExcelData = [];

// Initialize app
document.addEventListener('DOMContentLoaded', () => {
    loadSavedTechId();
    initializeCalendar();
    loadSavedData();
    updateConnectionStatus();
    
    // Set initial view state
    document.body.classList.add('map-view-active');
});

// Data storage functions
function saveDataLocally() {
    try {
        const dataToSave = {
            appointments: appointments,
            serviceOrders: serviceOrders,
            allExcelData: allExcelData,
            techId: currentTechId,
            timestamp: new Date().toISOString()
        };
        
        const dataString = JSON.stringify(dataToSave);
        const blob = new Blob([dataString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `route_data_${currentTechId || 'backup'}_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showSuccess('Data saved successfully!');
    } catch (error) {
        showError('Failed to save data: ' + error.message);
    }
}

function loadDataLocally() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                appointments = data.appointments || [];
                serviceOrders = data.serviceOrders || [];
                allExcelData = data.allExcelData || [];
                
                if (data.techId) {
                    currentTechId = data.techId;
                    document.getElementById('techIdInput').value = currentTechId;
                    saveTechId(currentTechId);
                }
                
                renderAppointments();
                updateMap();
                renderCalendar();
                updateLastUpdatedTime();
                
                showSuccess('Data loaded successfully!');
            } catch (error) {
                showError('Failed to load data: Invalid file format');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

function exportToExcel() {
    if (appointments.length === 0 && serviceOrders.length === 0) {
        showError('No data to export');
        return;
    }
    
    try {
        const wb = XLSX.utils.book_new();
        
        // Export appointments
        if (appointments.length > 0) {
            const appointmentData = appointments.map((appt, index) => ({
                'Order': index + 1,
                'Customer Name': appt.customerName,
                'Address': appt.address,
                'Phone': appt.phone,
                'Time Slot': appt.timeSlot,
                'RNN': appt.rnn,
                'Notes': appt.notes,
                'Status': appt.status
            }));
            
            const ws1 = XLSX.utils.json_to_sheet(appointmentData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Appointments');
        }
        
        // Export service orders
        if (serviceOrders.length > 0) {
            const serviceData = serviceOrders.map(order => ({
                'ID': order.id,
                'Customer Name': order.customerName,
                'Address': order.address,
                'Service Date': order.serviceDate,
                'Time': order.time,
                'Service': order.service,
                'Status': order.status,
                'Model': order.model,
                'Serial': order.serial
            }));
            
            const ws2 = XLSX.utils.json_to_sheet(serviceData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Service Orders');
        }
        
        XLSX.writeFile(wb, `route_export_${currentTechId || 'data'}_${new Date().toISOString().split('T')[0]}.xlsx`);
        showSuccess('Data exported to Excel successfully!');
    } catch (error) {
        showError('Failed to export data: ' + error.message);
    }
}

function clearAllData() {
    if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
        appointments = [];
        serviceOrders = [];
        allExcelData = [];
        renderAppointments();
        updateMap();
        renderCalendar();
        showSuccess('All data cleared');
    }
}

function loadSavedData() {
    // Try to load any previously saved data from localStorage
    try {
        const savedAppointments = localStorage.getItem('savedAppointments');
        const savedServiceOrders = localStorage.getItem('savedServiceOrders');
        
        if (savedAppointments) {
            appointments = JSON.parse(savedAppointments);
        }
        if (savedServiceOrders) {
            serviceOrders = JSON.parse(savedServiceOrders);
        }
        
        if (appointments.length > 0 || serviceOrders.length > 0) {
            renderAppointments();
            updateMap();
            renderCalendar();
        }
    } catch (error) {
        console.log('No saved data found or data corrupted');
    }
}

function saveToLocalStorage() {
    try {
        localStorage.setItem('savedAppointments', JSON.stringify(appointments));
        localStorage.setItem('savedServiceOrders', JSON.stringify(serviceOrders));
    } catch (error) {
        console.log('Failed to save to localStorage:', error);
    }
}

// Excel file handling functions
function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Check if filename starts with required prefix
    if (!file.name.startsWith('ExportExcel_Service List Info_')) {
        showError('File must start with "ExportExcel_Service List Info_"');
        event.target.value = '';
        return;
    }
    
    uploadedExcelFile = file;
    document.getElementById('passwordSection').style.display = 'block';
    document.getElementById('excelPassword').value = 'Winter1!'; // Pre-fill default password
    showSuccess(`File "${file.name}" selected. Ready to process.`);
}

async function processExcelFile() {
    if (!uploadedExcelFile) {
        showError('Please select an Excel file first');
        return;
    }
    
    if (!currentTechId) {
        showError('Please enter a Tech ID first');
        return;
    }
    
    const password = document.getElementById('excelPassword').value;
    if (!password) {
        showError('Please enter the Excel password');
        return;
    }
    
    try {
        // Read and process Excel file
        const arrayBuffer = await uploadedExcelFile.arrayBuffer();
        let workbook;
        
        // Try multiple approaches for password-protected files
        try {
            // First attempt: Standard password reading
            workbook = XLSX.read(arrayBuffer, { 
                type: 'array',
                password: password,
                cellStyles: true,
                cellFormulas: true,
                cellDates: true
            });
        } catch (passwordError) {
            console.log('Standard password method failed:', passwordError.message);
            
            try {
                // Second attempt: Try without password (in case file isn't actually protected)
                workbook = XLSX.read(arrayBuffer, { 
                    type: 'array',
                    cellStyles: true,
                    cellFormulas: true,
                    cellDates: true
                });
                showSuccess('File opened without password - it may not be password protected');
            } catch (noPasswordError) {
                console.log('No password method failed:', noPasswordError.message);
                
                try {
                    // Third attempt: Try with different password options
                    workbook = XLSX.read(arrayBuffer, { 
                        type: 'array',
                        password: password,
                        WTF: 1 // Enable more lenient parsing
                    });
                } catch (finalError) {
                    // Password failed with all methods
                    if (password === 'Winter1!') {
                        document.getElementById('excelPassword').value = '';
                        document.getElementById('excelPassword').placeholder = 'Default password failed - enter current password';
                        showError('Default password "Winter1!" failed. The file may use a different password or encryption method.');
                        return;
                    } else {
                        showError(`Password "${password}" failed to unlock the file. Please verify the password is correct or check if the file uses a different encryption method.`);
                        return;
                    }
                }
            }
        }
        
        // Check if workbook was successfully created
        if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
            showError('Failed to read Excel file - the file may be corrupted or use an unsupported format');
            return;
        }
        
        showSuccess('Excel file opened successfully!');
        
        // Process all worksheets
        const processedData = {};
        workbook.SheetNames.forEach(sheetName => {
            try {
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1,
                    defval: '', // Default value for empty cells
                    blankrows: false // Skip blank rows
                });
                processedData[sheetName] = jsonData;
                console.log(`Processed sheet: ${sheetName} with ${jsonData.length} rows`);
            } catch (sheetError) {
                console.log(`Error processing sheet ${sheetName}:`, sheetError.message);
                showError(`Warning: Could not process sheet "${sheetName}"`);
            }
        });
        
        // Store all Excel data
        allExcelData = processedData;
        
        // Process dispatch data if available
        if (processedData['Dispatch'] || processedData['Sheet1']) {
            const dispatchData = processedData['Dispatch'] || processedData['Sheet1'];
            await processDispatchData(dispatchData);
            showSuccess(`Processed ${appointments.length} appointments for Tech ID: ${currentTechId}`);
        } else {
            showError('No Dispatch or Sheet1 data found in Excel file');
        }
        
        // Process EL data if available
        if (processedData['EL']) {
            await processELData(processedData['EL']);
            showSuccess(`Processed ${serviceOrders.length} service orders from EL sheet`);
        }
        
        // Save data locally
        saveToLocalStorage();
        
        showSuccess('Excel file processed and data saved successfully!');
        
        // Clear file input and hide password section
        document.getElementById('excelFileInput').value = '';
        document.getElementById('passwordSection').style.display = 'none';
        uploadedExcelFile = null;
        
        // Refresh displays
        renderAppointments();
        updateMap();
        renderCalendar();
        updateLastUpdatedTime();
        
    } catch (error) {
        console.error('Error processing Excel file:', error);
        showError('Failed to process Excel file: ' + error.message);
        
        // Provide more specific guidance
        if (error.message.includes('password') || error.message.includes('encrypted')) {
            showError('This appears to be a password-protected file. Please verify the password or try opening the file in Excel first to check if it requires a different password.');
        } else if (error.message.includes('format')) {
            showError('The file format may not be supported. Please ensure it is a valid .xlsx or .xls file.');
        }
    }
}

async function processDispatchData(dispatchValues) {
    if (!dispatchValues || dispatchValues.length === 0) return;
    
    const filteredData = [];
    
    for (let i = 1; i < dispatchValues.length; i++) {
        const row = dispatchValues[i];
        const techIdCol = row[1] || '';
        const customerCol = row[11] || '';
        const addressCol = row[13] || '';
        const timeSlotCol = row[9] || '';
        const phoneCol = row[10] || '';
        const rnnCol = row[6] || '';
        
        if (techIdCol === currentTechId && techIdCol !== '' && customerCol !== '') {
            filteredData.push({
                customerName: customerCol,
                address: addressCol,
                phone: phoneCol,
                timeSlot: timeSlotCol,
                rnn: rnnCol,
                notes: '',
                sortKey: row[2] || ''
            });
        }
    }
    
    // Sort by sort key
    filteredData.sort((a, b) => {
        const aNum = parseInt(a.sortKey) || 0;
        const bNum = parseInt(b.sortKey) || 0;
        return aNum - bNum;
    });
    
    // Convert to appointments format
    appointments = filteredData.map((item, index) => ({
        id: `appt_${index}`,
        customerName: item.customerName,
        address: item.address,
        phone: item.phone,
        timeSlot: item.timeSlot,
        notes: item.notes,
        rnn: item.rnn,
        status: 'pending'
    }));
    
    // Try to populate notes from EL data if available
    if (allExcelData['EL']) {
        populateNotesFromEL(appointments);
    }
}

async function processELData(elValues) {
    if (!elValues || elValues.length === 0) return;
    
    serviceOrders = elValues.slice(1).map(row => ({
        id: row[0] || '', 
        customerName: row[14] || '', 
        address: (row[68] && row[69]) ? `${row[68]}, ${row[69]}` : (row[68] || 'Unknown City, CA'), 
        serviceDate: row[30] || '', 
        time: row[31] || '', 
        service: row[5] || '', 
        status: row[55] || '',
        model: row[6] || '', 
        serial: row[7] || '', 
        symptom1: row[79] || '', 
        symptom2: row[80] || '', 
        cicRemark: row[92] || '', 
        lgRemarks: row[72] || '' 
    })).filter(order => order.customerName && order.serviceDate);
}

function populateNotesFromEL(appointmentsList) {
    if (!allExcelData['EL'] || appointmentsList.length === 0) return;
    
    const elValues = allExcelData['EL'];
    const rnnToNotes = {};
    
    for (let i = 1; i < elValues.length; i++) {
        const elRow = elValues[i];
        const elRnn = elRow[0] || '';
        const elNotes = elRow[55] || '';
        
        if (elRnn && elNotes) {
            rnnToNotes[elRnn] = elNotes;
        }
    }
    
    appointmentsList.forEach(appointment => {
        if (appointment.rnn && rnnToNotes[appointment.rnn]) {
            appointment.notes = rnnToNotes[appointment.rnn];
        }
    });
}

// Tech ID functions
function loadSavedTechId() {
    const savedTechId = localStorage.getItem('savedTechId');
    if (savedTechId) {
        document.getElementById('techIdInput').value = savedTechId;
        currentTechId = savedTechId;
    }
}

function saveTechId(techId) {
    localStorage.setItem('savedTechId', techId);
}

function onTechIdChange() {
    const techId = document.getElementById('techIdInput').value.trim();
    currentTechId = techId;
    saveTechId(techId);
    
    // Reprocess data if we have Excel data loaded
    if (allExcelData && Object.keys(allExcelData).length > 0) {
        if (allExcelData['Dispatch'] || allExcelData['Sheet1']) {
            const dispatchData = allExcelData['Dispatch'] || allExcelData['Sheet1'];
            processDispatchData(dispatchData);
            renderAppointments();
            updateMap();
            saveToLocalStorage();
        }
    }
}

// Map Functions
function initMap() {
    const mapOptions = {
        zoom: 10,
        center: { lat: 40.2987, lng: -111.7584 },
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
    };
    map = new google.maps.Map(document.getElementById('map'), mapOptions);
    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        polylineOptions: {
            strokeColor: '#ff6b35',
            strokeWeight: 4,
            strokeOpacity: 0.8
        }
    });
    directionsRenderer.setMap(map);
    console.log("Google Map initialized.");
}

function updateMap() {
    if (!map || appointments.length === 0) return;

    // Clear existing markers and info windows
    markers.forEach(marker => marker.setMap(null));
    markers = [];
    infoWindows = [];
    
    const bounds = new google.maps.LatLngBounds();

    appointments.forEach((a, index) => {
        if (!a.address) return;
        
        // Geocode using only the address, not the customer name
        geocoder.geocode({ 'address': a.address }, (results, status) => {
            if (status === 'OK') {
                const marker = new google.maps.Marker({
                    map: map,
                    position: results[0].geometry.location,
                    title: `${a.customerName} - ${a.rnn}`,
                    label: (index + 1).toString(),
                    appointmentId: a.id
                });

                const infoContent = `
                    <div style="color: black;">
                        <strong>${a.customerName} - ${a.rnn}</strong><br>
                        <em>Address:</em> ${a.address}<br>
                        <em>Geocoded:</em> ${results[0].formatted_address}<br>
                        Time Slot: ${a.timeSlot}
                    </div>
                `;
                const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                
                marker.addListener('click', () => {
                    infoWindows.forEach(infowin => infowin.close());
                    infoWindow.open(map, marker);
                    highlightCard(a.id);
                });
                
                markers.push(marker);
                infoWindows.push(infoWindow);
                bounds.extend(marker.getPosition());
                
                // If all markers are placed, draw the route
                if (markers.length === appointments.filter(a => a.address).length) {
                    map.fitBounds(bounds);
                    drawRoute();
                }

            } else {
                console.error(`Geocoding failed for address: "${a.address}" (${a.customerName}) - Status: ${status}`);
            }
        });
    });
}

function drawRoute() {
    if (!directionsService || !directionsRenderer || appointments.length < 2) {
        return;
    }
    
    const validAppointments = appointments.filter(a => a.address);
    if (validAppointments.length < 2) return;
    
    const origin = validAppointments[0].address;
    const destination = validAppointments[validAppointments.length - 1].address;
    const waypoints = validAppointments.slice(1, -1).map(a => ({
        location: a.address,
        stopover: true
    }));
    
    const request = {
        origin: origin,
        destination: destination,
        waypoints: waypoints,
        travelMode: google.maps.TravelMode.DRIVING,
        optimizeWaypoints: false
    };
    
    directionsService.route(request, (result, status) => {
        if (status === 'OK') {
            directionsRenderer.setDirections(result);
        } else {
            console.warn('Directions request failed due to ' + status);
        }
    });
}

function highlightMapMarker(id) {
    const card = document.querySelector(`.appointment-card[data-id="${id}"]`);
    if (card) {
        highlightCard(id);
        const marker = markers.find(m => m.appointmentId === id);
        if (marker) {
            map.panTo(marker.position);
            infoWindows.forEach(infowin => infowin.close());
            const markerIndex = markers.indexOf(marker);
            if (infoWindows[markerIndex]) {
                infoWindows[markerIndex].open(map, marker);
            }
        }
    }
}

function highlightCard(id) {
    document.querySelectorAll('.appointment-card').forEach(card => {
        card.classList.remove('highlight');
        if (card.getAttribute('data-id') === id) {
            card.classList.add('highlight');
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
}

function openGoogleMapsRoute() {
    if (appointments.length === 0) {
        showError('No appointments available to create route');
        return;
    }
    
    let mapsUrl = 'https://www.google.com/maps/dir/';
    
    appointments.forEach((appointment, index) => {
        if (appointment.address) {
            const encodedAddress = encodeURIComponent(appointment.address);
            mapsUrl += '/' + encodedAddress;
        }
    });
    
    mapsUrl += '/@?hl=en&gl=US';
    
    window.open(mapsUrl, '_blank');
    
    showSuccess(`Opening route with ${appointments.length} stops in Google Maps`);
}

function showSuccess(message) {
    const errorContainer = document.getElementById('errorContainer');
    errorContainer.textContent = '✅ ' + message;
    errorContainer.className = 'error';
    errorContainer.style.background = 'rgba(76,175,80,0.2)';
    errorContainer.style.color = '#4caf50';
    setTimeout(() => errorContainer.textContent = '', 3000);
}

function showError(message) {
    const errorContainer = document.getElementById('errorContainer');
    errorContainer.textContent = '❌ ' + message;
    errorContainer.className = 'error';
    errorContainer.style.background = 'rgba(244,67,54,0.2)';
    errorContainer.style.color = '#f44336';
    setTimeout(() => errorContainer.textContent = '', 5000);
}

function updateConnectionStatus() {
    const statusDiv = document.getElementById('connectionStatus');
    statusDiv.textContent = '💾 Local data storage active';
    statusDiv.className = 'connection-status status-connected';
}

function updateLastUpdatedTime() {
    const lastUpdatedDiv = document.getElementById('lastUpdated') || createLastUpdatedDiv();
    const now = new Date();
    lastUpdatedDiv.textContent = `Last Updated: ${now.toLocaleTimeString()}`;
}

function createLastUpdatedDiv() {
    const div = document.createElement('div');
    div.id = 'lastUpdated';
    div.className = 'last-updated';
    document.querySelector('.appointments-section').appendChild(div);
    return div;
}

function toggleDataConfig() {
    const config = document.querySelector('.data-config');
    config.style.display = (config.style.display === 'none' || config.style.display === '') ? 'block' : 'none';
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
    
    const mapView = document.getElementById('mapView');
    const calendarView = document.getElementById('calendarView');
    
    if (tabName === 'map') {
        mapView.style.display = 'grid';
        calendarView.style.display = 'none';
        document.body.classList.add('map-view-active');
        updateMap();
    } else {
        mapView.style.display = 'none';
        calendarView.style.display = 'block';
        document.body.classList.remove('map-view-active');
        renderCalendar();
    }
}

// Calendar functions
function initializeCalendar() {
    const today = new Date();
    currentWeekStart = new Date(today);
    currentWeekStart.setDate(today.getDate() - today.getDay());
    renderCalendar();
}

function navigateWeek(direction) {
    currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
    renderCalendar();
}

function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    const title = document.getElementById('calendarTitle');
    
    if (!grid || !title) return;
    
    try {
        title.textContent = `Week of ${currentWeekStart.toLocaleDateString('en-US', {month: 'long', day: 'numeric'})}, ${currentWeekStart.getFullYear()}`;
        
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        let gridHTML = '';
        
        for (let i = 0; i < 7; i++) {
            const dayDate = new Date(currentWeekStart);
            dayDate.setDate(currentWeekStart.getDate() + i);
            
            const today = new Date();
            const isToday = dayDate.toDateString() === today.toDateString();
            const dayClass = isToday ? 'calendar-day today' : 'calendar-day';
            const dayName = dayNames[i];
            
            let dayOrders = [];
            try {
                if (serviceOrders && serviceOrders.length > 0) {
                    dayOrders = serviceOrders.filter(order => {
                        if (!order.serviceDate) return false;
                        let orderDate = new Date(order.serviceDate.toString().trim());
                        return orderDate.toDateString() === dayDate.toDateString();
                    });
                }
            } catch (err) {
                dayOrders = [];
            }
            
            gridHTML += `<div class="${dayClass}">
                <div class="day-header">${dayName} ${dayDate.getDate()}</div>`;
            
            const morningOrders = dayOrders.filter(order => order.time && order.time.toLowerCase().includes('morning'));
            const afternoonOrders = dayOrders.filter(order => order.time && order.time.toLowerCase().includes('afternoon'));
            
            gridHTML += `<div class="appointments-section-calendar">`;
            
            morningOrders.forEach(order => {
                const notes = (order.status || '').substring(0, 40) + ((order.status || '').length > 40 ? '...' : '');
                gridHTML += `<div class="service-card" 
                    data-order-id="${order.id || ''}" 
                    data-customer="${order.customerName || ''}" 
                    data-service="${order.service || ''}" 
                    data-location="${order.address || ''}" 
                    data-notes="${order.status || ''}" 
                    data-model="${order.model || ''}"
                    data-serial="${order.serial || ''}"
                    data-symptom1="${order.symptom1 || ''}"
                    data-symptom2="${order.symptom2 || ''}"
                    data-cic-remark="${order.cicRemark || ''}"
                    data-lg-remarks="${order.lgRemarks || ''}"
                    data-time="morning" onclick="openModal(this)">
                    <div class="service-card-name">
                        <span>${order.customerName || 'Unknown'}</span>
                        ${order.service ? `<span>${order.service}</span>` : ''}
                    </div>
                    ${order.address ? `<div class="service-card-location">${order.address}</div>` : ''}
                    ${notes ? `<div class="service-card-notes">${notes}</div>` : ''}
                </div>`;
            });
            
            afternoonOrders.forEach(order => {
                const notes = (order.status || '').substring(0, 40) + ((order.status || '').length > 40 ? '...' : '');
                gridHTML += `<div class="service-card afternoon" 
                    data-order-id="${order.id || ''}" 
                    data-customer="${order.customerName || ''}" 
                    data-service="${order.service || ''}" 
                    data-location="${order.address || ''}" 
                    data-notes="${order.status || ''}" 
                    data-model="${order.model || ''}"
                    data-serial="${order.serial || ''}"
                    data-symptom1="${order.symptom1 || ''}"
                    data-symptom2="${order.symptom2 || ''}"
                    data-cic-remark="${order.cicRemark || ''}"
                    data-lg-remarks="${order.lgRemarks || ''}"
                    data-time="afternoon" onclick="openModal(this)">
                    <div class="service-card-name">
                        <span>${order.customerName || 'Unknown'}</span>
                        ${order.service ? `<span>${order.service}</span>` : ''}
                    </div>
                    ${order.address ? `<div class="service-card-location">${order.address}</div>` : ''}
                    ${notes ? `<div class="service-card-notes">${notes}</div>` : ''}
                </div>`;
            });
            gridHTML += `</div></div>`;
        }
        
        grid.innerHTML = gridHTML;
    } catch (error) {
        console.error('Error rendering calendar:', error);
        grid.innerHTML = '<div style="text-align:center;padding:20px;color:#ff6b6b;">Error loading calendar.</div>';
    }
}

// Modal functions
function openModal(element) {
    const orderId = element.getAttribute('data-order-id') || 'N/A';
    const customerName = element.getAttribute('data-customer') || 'Unknown Customer';
    const serviceType = element.getAttribute('data-service') || 'No Service Type';
    const location = element.getAttribute('data-location') || 'No Location';
    const notes = element.getAttribute('data-notes') || 'No notes available';
    const timeSlot = element.getAttribute('data-time');
    const model = element.getAttribute('data-model') || 'Not specified';
    const serial = element.getAttribute('data-serial') || 'Not specified';
    const symptom1 = element.getAttribute('data-symptom1') || 'Not specified';
    const symptom2 = element.getAttribute('data-symptom2') || 'Not specified';
    const cicRemark = element.getAttribute('data-cic-remark') || 'Not specified';
    const lgRemarks = element.getAttribute('data-lg-remarks') || 'Not specified';
    
    document.getElementById('modalCustomer').textContent = customerName;
    document.getElementById('modalService').textContent = serviceType;
    document.getElementById('modalOrderId').textContent = orderId;
    document.getElementById('modalLocation').textContent = location;
    document.getElementById('modalTimeSlot').textContent = timeSlot === 'morning' ? 'Morning' : timeSlot === 'afternoon' ? 'Afternoon' : timeSlot;
    document.getElementById('modalSerial').textContent = serial;
    document.getElementById('modalModel').textContent = model;
    document.getElementById('modalSymptom1').textContent = symptom1;
    document.getElementById('modalSymptom2').textContent = symptom2;
    document.getElementById('modalCicRemark').textContent = cicRemark;
    document.getElementById('modalLgRemarks').textContent = lgRemarks;
    document.getElementById('modalNotes').textContent = notes;
    
    document.getElementById('appointmentModal').classList.add('show');
}

function closeAppointmentModal() {
    document.getElementById('appointmentModal').classList.remove('show');
}

document.addEventListener('click', function(event) {
    const modal = document.getElementById('appointmentModal');
    const dataConfig = document.querySelector('.data-config');
    const toggleBtn = document.querySelector('.data-toggle-btn');

    if (event.target === modal) closeAppointmentModal();
    
    if (!dataConfig.contains(event.target) && event.target !== toggleBtn && !toggleBtn.contains(event.target)) {
        dataConfig.style.display = 'none';
    }
});

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeAppointmentModal();
        document.querySelector('.data-config').style.display = 'none';
    }
});

function renderAppointments() {
    const list = document.getElementById('appointmentsList');
    if(appointments.length === 0){
        const message = currentTechId ? 
            `No appointments found for Tech ID: ${currentTechId}` : 
            'Upload an Excel file and enter a Tech ID to load appointments';
        list.innerHTML = `<div class="no-data-message">${message}</div>`;
        return;
    }
    
    let html = '';
    appointments.forEach((a, index) => {
        html += `
            <div class="appointment-card" data-id="${a.id}" data-index="${index}" onclick="highlightMapMarker('${a.id}')">
                <button class="reorder-btn reorder-up" onclick="event.stopPropagation(); reorderAppointment(${index}, -1)" ${index === 0 ? 'disabled' : ''}>▲</button>
                <button class="reorder-btn reorder-down" onclick="event.stopPropagation(); reorderAppointment(${index}, 1)" ${index === appointments.length - 1 ? 'disabled' : ''}>▼</button>
                <div class="card-content">
                    <div class="appointment-top-row">
                        <button class="time-slot-btn ${a.timeSlot && a.timeSlot.toLowerCase().includes('afternoon') ? 'afternoon' : ''}">${a.timeSlot || 'Anytime'}</button>
                        ${a.status && a.status.toLowerCase() === 'complete' ? 
                            '<button class="complete-btn" disabled>✔️ Completed</button>' : 
                            '<button class="complete-btn" onclick="event.stopPropagation(); updateAppointmentStatus(\''+a.id+'\', \'completed\')">Complete</button>'}
                    </div>
                    <div class="customer-info">
                        <div class="customer-name">${a.customerName || 'Unknown'}</div>
                        <span class="rnn-number">${a.rnn || '#' + (index + 1)}</span>
                    </div>
                    <a href="http://maps.google.com/?q=${encodeURIComponent(a.address || '')}" target="_blank" class="address-link" onclick="event.stopPropagation()">${a.address || 'No Address'}</a>
                    <div class="phone-container">
                        ${a.phone ? `<span class="phone-number">${a.phone}</span>` : '<span></span>'}
                        <div class="phone-buttons">
                            ${a.phone ? `<a href="tel:${a.phone}" class="phone-btn call-btn" onclick="event.stopPropagation()">📞 Call</a>` : ''}
                            ${a.phone ? `<a href="sms:${a.phone}" class="phone-btn text-btn" onclick="event.stopPropagation()">💬 Text</a>` : ''}
                        </div>
                    </div>
                    ${a.notes ? `<div class="order-info">${a.notes}</div>` : ''}
                </div>
            </div>
        `;
    });
    
    list.innerHTML = html;
}

function reorderAppointment(fromIndex, direction) {
    if (fromIndex < 0 || fromIndex >= appointments.length) return;
    
    const toIndex = fromIndex + direction;
    if (toIndex < 0 || toIndex >= appointments.length) return;
    
    // Swap appointments
    const temp = appointments[fromIndex];
    appointments[fromIndex] = appointments[toIndex];
    appointments[toIndex] = temp;
    
    // Re-render the appointments list
    renderAppointments();
    
    // Update the map with new order
    updateMap();
    
    // Save changes
    saveToLocalStorage();
    
    showSuccess(`Moved ${temp.customerName} ${direction > 0 ? 'down' : 'up'} in route order`);
}

function updateAppointmentStatus(id, status) {
    const appointmentIndex = appointments.findIndex(a => a.id === id);
    if (appointmentIndex !== -1) {
        const appointment = appointments[appointmentIndex];
        appointment.status = status;
        
        if (status === 'completed') {
            // Remove the completed appointment from the array
            appointments.splice(appointmentIndex, 1);
            showSuccess(`Appointment for ${appointment.customerName} marked as completed and removed from route`);
            
            // Re-render appointments and update map
            renderAppointments();
            updateMap();
        } else {
            showSuccess(`Appointment for ${appointment.customerName} marked as ${status}`);
            renderAppointments();
        }
        
        // Save changes
        saveToLocalStorage();
    }
}
</script>
</body>
</html>
